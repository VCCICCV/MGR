## Order中心
电商系统涉及三个流：信息流、资金流、物流

订单模块将多个模块的数据和信息加工和处理构成订单信息流通
## 构成
* 用户信息
* 订单信息
* 支付信息
* 促销信息
* 商品信息
* 物流信息
## 订单状态
* 未付款：预下单，支付超时后取消订单
* 已取消：付款前取消订单或超时未付款自动取消
* 已付款：记录支付时间、支付流水单便于对账
* 待发货：仓库进行调拨、配货、分拣、出库
* 已发货/待收货：物流发货
* 已签收：物流签收
* 已完成：确认收货后订单完成，订单交易完成
* 售后中：付款后，申请售后
## 订单流程
订单生成->订单付款->卖家发货->物流签收->交易完成
## 幂等性处理
* 重复支付：由于网络波动、用户误操作或者系统故障，可能会导致用户多次点击支付按钮。例如，用户在支付页面因为网络延迟没有及时收到支付成功的反馈，从而再次触发支付操作。如果没有幂等性处理，可能会导致用户被多次扣款。
* 支付回调：付平台在完成支付后会向电商系统发送支付回调通知。由于网络等因素，这个回调通知可能会被多次发送。电商系统需要保证无论收到多少次相同支付结果的回调，对订单的处理（如更新订单状态为已支付）结果都是相同的，不会出现重复更新导致数据不一致的情况。
* 重复提交订单：当用户在下单页面提交订单后，如果因为前端页面卡顿或者网络问题，用户可能会多次点击提交订单按钮。系统应该能够识别这些重复的订单创建请求，确保只会创建一个有效的订单，避免生成多个相同的订单记录
* 重复扣减库存（防超卖）：在高并发场景下，可能会出现多个相同的库存扣减请求同时到达系统。例如，多个请求同时处理同一个商品的库存扣减，或者在分布式系统中，由于网络分区等原因，一个库存扣减请求被重复发送。幂等性处理能够保证库存只会被正确地扣减一次，防止超卖现象。
* 优惠券使用：当用户使用优惠券进行下单时，如果系统没有幂等性保证，可能会出现用户重复使用同一张优惠券的情况。例如，在优惠券核销过程中，由于网络问题或者系统重试机制，导致同一张优惠券被多次核销，这会给商家带来损失。
* 满减活动：如果因为系统故障或者重试导致多次计算满减，可能会导致订单金额计算错误。
* 发货通知：电商系统向物流系统发送发货通知时，可能会因为网络不稳定等原因，发货通知被重复发送。
## 确认订单需要的数据
* 收货地址
* 发货清单：所有选中的购物项
  * 商品信



## 如何保证事务
订单创建成功后向事件表插入订单创建成功的事件，库存服务订阅事件进行扣减，扣减成功后向事件表插入库存扣减成功的消息，扣减失败回滚库存本地事务，发送消息扣减失败，订单服务订阅事件进行补偿
## saga事务
saga有三种形式
* 协同模式（Choreography）：参与者订阅彼此事件并做出响应，参与者根据事件做出相应的补偿操作
* 状态机：
* 编排模式（Orchestration）：使用saga协调者